import os
import sys
from launch import LaunchDescriptor
from launch.exit_handler import ignore_signal_exit_handler, primary_exit_handler
from launch.launcher import DefaultLauncher
from launch.output_handler import ConsoleOutput
from launch_testing import create_handler


def setup():
    os.environ['OSPL_VERBOSITY'] = '8'  # 8 = OS_NONE


def test_executable():
    timeout = 1
    launch_descriptor = LaunchDescriptor()

    executable = '@IMAGE_TOOLS_EXECUTABLE@'
    name = 'test_executable_0'
    launch_descriptor.add_process(
        cmd=[executable],
        name=name,
        exit_handler=ignore_signal_exit_handler,
        output_handlers=[ConsoleOutput()],
    )

    launch_descriptor.add_process(
        cmd=['python3', '-c', 'import time; time.sleep(%d)' % timeout],
        name='primary_executable',
        exit_handler=primary_exit_handler)

    launcher = DefaultLauncher()
    launcher.add_launch_descriptor(launch_descriptor)
    rc = launcher.launch()
    assert rc == 0, "The launch file failed with exit code '" + str(rc) + "'. "

if __name__ == '__main__':
    test_executable()
